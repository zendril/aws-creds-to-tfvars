on:
  push:
    # Pattern matched against refs/tags
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

name: Publish

jobs:
#  ci:
#    uses: ./.github/workflows/ci.yml
#  publish-crate:
#    name: Publish
#    needs: [CI]
#    runs-on: ubuntu-latest
#    steps:
#      - name: Checkout sources
#        uses: actions/checkout@v3
#
#      - name: Install stable toolchain
#        uses: dtolnay/rust-toolchain@master
#        with:
#          toolchain: stable
#      - run: cargo publish -p actfv --token ${CRATES_TOKEN}
#        env:
#          CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}
  publish-release-linux:
    name: Publish Release Linux
#    needs: [CI]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Build
        run: cargo build --all --release && strip target/release/actfv && mv target/release/actfv target/release/actfv_amd64

#      - run: cargo publish -p actfv --token ${CRATES_TOKEN}
#        env:
#          CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@v1
#        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            target/release/actfv_amd64
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}